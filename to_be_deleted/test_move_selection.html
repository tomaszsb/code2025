<!DOCTYPE html>
<html>
<head>
    <title>Test Move Selection Fix</title>
</head>
<body>
    <h1>Testing Move Selection Fix</h1>
    <div id="test-results"></div>
    
    <script>
        // Simulate the key parts of our system
        const mockGameBoard = {
            state: {
                hasSelectedMove: false,
                selectedMove: null,
                spaces: [
                    { id: 'owner-fund-initiation-first', name: 'OWNER-FUND-INITIATION' }
                ]
            },
            setState: function(newState, callback) {
                Object.assign(this.state, newState);
                console.log('GameBoard state updated:', this.state);
                if (callback) callback();
            }
        };
        
        const mockGameStateManager = {
            dispatchEvent: function(eventType, data) {
                console.log('Event dispatched:', eventType, data);
            }
        };
        
        // Mock SpaceSelectionManager with our new method
        const spaceSelectionManager = {
            gameBoard: mockGameBoard,
            
            // New method that should fix the issue
            handleMoveSelection: function(moveId) {
                console.log('Direct move selection:', moveId);
                
                const spaceData = this.gameBoard.state.spaces.find(space => space.id === moveId);
                
                this.gameBoard.setState({
                    selectedMove: moveId,
                    hasSelectedMove: true,  // This enables the End Turn button
                    exploredSpace: spaceData
                }, () => {
                    console.log('Move selected - End Turn button should now be enabled');
                });
                
                mockGameStateManager.dispatchEvent('spaceSelected', {
                    spaceId: moveId,
                    spaceData: spaceData,
                    isValidMove: true,
                    selectedForMove: true,
                    source: 'directMoveSelection'
                });
                
                console.log('Move selection completed - ready for End Turn');
            }
        };
        
        // Test the fix
        function testMoveSelection() {
            const resultsDiv = document.getElementById('test-results');
            
            // Initial state
            resultsDiv.innerHTML += '<p><strong>Initial state:</strong></p>';
            resultsDiv.innerHTML += `<p>hasSelectedMove: ${mockGameBoard.state.hasSelectedMove}</p>`;
            resultsDiv.innerHTML += `<p>selectedMove: ${mockGameBoard.state.selectedMove}</p>`;
            
            // Simulate clicking a move button
            resultsDiv.innerHTML += '<p><strong>Simulating move button click...</strong></p>';
            spaceSelectionManager.handleMoveSelection('owner-fund-initiation-first');
            
            // Check final state
            resultsDiv.innerHTML += '<p><strong>Final state:</strong></p>';
            resultsDiv.innerHTML += `<p>hasSelectedMove: ${mockGameBoard.state.hasSelectedMove}</p>`;
            resultsDiv.innerHTML += `<p>selectedMove: ${mockGameBoard.state.selectedMove}</p>`;
            
            // Check if End Turn would be enabled
            const currentPlayer = { id: 'player1', name: 'Player 1' };
            const hasDiceRollSpace = false;
            const hasRolledDice = true;
            
            const endTurnEnabled = currentPlayer && 
                                 mockGameBoard.state.hasSelectedMove && 
                                 (!hasDiceRollSpace || hasRolledDice);
            
            resultsDiv.innerHTML += `<p><strong>End Turn button enabled: ${endTurnEnabled ? 'YES ✓' : 'NO ✗'}</strong></p>`;
            
            if (endTurnEnabled) {
                resultsDiv.innerHTML += '<p style="color: green; font-weight: bold;">✓ FIX SUCCESSFUL! Move selection now enables End Turn button.</p>';
            } else {
                resultsDiv.innerHTML += '<p style="color: red; font-weight: bold;">✗ Fix failed. End Turn button still not enabled.</p>';
            }
        }
        
        // Run the test
        testMoveSelection();
    </script>
</body>
</html>
