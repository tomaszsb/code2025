<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Test Page</title>
    
    <!-- React from CDN -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2 {
            color: #333;
        }
        
        .game-board {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .space {
            width: 100px;
            height: 80px;
            background-color: #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .space:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .space h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        
        .player-setup {
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .player-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        input, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .player-list {
            margin-top: 20px;
        }
        
        .player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: white;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        
        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .log-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Game Board Test</h1>
        <p>This is a simplified version of the game to test functionality.</p>
        
        <div id="game-root"></div>
    </div>
    
    <!-- CSV Parser Implementation -->
    <script type="text/babel">
        // Simple CSV Parser
        function parseCSV(csvText) {
            // Split by lines
            const lines = csvText.split('\n');
            // Extract headers (first line)
            const headers = lines[0].split(',').map(h => h.trim());
            
            // Parse rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // Skip empty lines
                
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                
                data.push(row);
            }
            
            return data;
        }
    </script>
    
    <!-- Game State Implementation -->
    <script type="text/babel">
        // Simplified Game State
        const GameState = {
            players: [],
            currentPlayerIndex: 0,
            spaces: [],
            gameStarted: false,
            logs: [],
            
            // Log events
            log(message) {
                console.log(message);
                this.logs.push(`${new Date().toLocaleTimeString()}: ${message}`);
                // Keep last 50 logs
                if (this.logs.length > 50) this.logs.shift();
            },
            
            // Initialize the game
            initialize(spacesData) {
                this.log('Initializing game with spaces data: ' + spacesData.length + ' spaces');
                
                this.spaces = spacesData.map(row => {
                    const spaceObj = {
                        id: row['Space Name'] ? row['Space Name'].replace(/\s+/g, '-').toLowerCase() : 'unknown-' + Math.random(),
                        name: row['Space Name'] || 'Unknown Space',
                        type: row['Phase'] || 'Unknown',
                        description: row['Event'] || 'No description',
                        nextSpaces: [
                            row['Space 1'], 
                            row['Space 2'], 
                            row['Space 3'],
                            row['Space 4'],
                            row['Space 5']
                        ].filter(s => s && s.trim() !== '')
                    };
                    return spaceObj;
                });
                
                this.loadSavedState();
                this.log('Game initialized. gameStarted=' + this.gameStarted + ', players=' + this.players.length);
            },
            
            // Add a new player
            addPlayer(name, color) {
                const id = `player-${this.players.length + 1}`;
                this.players.push({
                    id,
                    name,
                    color,
                    position: this.spaces[0]?.id || 'start',
                    resources: {
                        money: 1000,
                        time: 0
                    }
                });
                this.log(`Added player: ${name} with color ${color}`);
                this.saveState();
            },
            
            // Start the game
            startGame() {
                this.gameStarted = true;
                this.log('Game started with ' + this.players.length + ' players');
                this.saveState();
            },
            
            // Save state to localStorage
            saveState() {
                localStorage.setItem('game_players', JSON.stringify(this.players));
                localStorage.setItem('game_currentPlayer', this.currentPlayerIndex);
                localStorage.setItem('game_status', JSON.stringify({
                    started: this.gameStarted
                }));
                this.log('Game state saved to localStorage');
            },
            
            // Load state from localStorage
            loadSavedState() {
                try {
                    const savedPlayers = localStorage.getItem('game_players');
                    const savedCurrentPlayer = localStorage.getItem('game_currentPlayer');
                    const savedStatus = localStorage.getItem('game_status');
                    
                    this.log('Loading saved state from localStorage...');
                    
                    if (savedPlayers) {
                        this.players = JSON.parse(savedPlayers);
                        this.log('Loaded ' + this.players.length + ' players from localStorage');
                    }
                    
                    if (savedCurrentPlayer) {
                        this.currentPlayerIndex = parseInt(savedCurrentPlayer);
                    }
                    
                    if (savedStatus) {
                        const status = JSON.parse(savedStatus);
                        this.gameStarted = status.started;
                        this.log('Loaded game status: started=' + this.gameStarted);
                    }
                } catch (error) {
                    console.error('Error loading saved game:', error);
                    this.log('Error loading saved game: ' + error.message);
                    this.gameStarted = false;
                }
            },
            
            // Reset the game
            resetGame() {
                this.players = [];
                this.currentPlayerIndex = 0;
                this.gameStarted = false;
                localStorage.removeItem('game_players');
                localStorage.removeItem('game_currentPlayer');
                localStorage.removeItem('game_status');
                this.log('Game reset. All data cleared.');
            }
        };
    </script>
    
    <!-- Game Component -->
    <script type="text/babel">
        // Player Setup Component
        function PlayerSetup({ onStartGame }) {
            const [playerName, setPlayerName] = React.useState('');
            const [playerColor, setPlayerColor] = React.useState('#4287f5');
            
            const handleAddPlayer = () => {
                if (playerName.trim()) {
                    GameState.addPlayer(playerName, playerColor);
                    setPlayerName('');
                }
            };
            
            const handleStartGame = () => {
                if (GameState.players.length > 0) {
                    GameState.startGame();
                    if (onStartGame) onStartGame();
                }
            };
            
            return (
                <div className="player-setup">
                    <h2>Player Setup</h2>
                    
                    <div className="player-form">
                        <input 
                            type="text" 
                            value={playerName} 
                            onChange={e => setPlayerName(e.target.value)}
                            placeholder="Player Name"
                        />
                        <input 
                            type="color" 
                            value={playerColor}
                            onChange={e => setPlayerColor(e.target.value)}
                        />
                        <button onClick={handleAddPlayer}>Add Player</button>
                    </div>
                    
                    <div className="player-list">
                        <h3>Players ({GameState.players.length})</h3>
                        {GameState.players.map(player => (
                            <div key={player.id} className="player">
                                <div 
                                    className="player-color" 
                                    style={{ backgroundColor: player.color }}
                                ></div>
                                <div>{player.name}</div>
                            </div>
                        ))}
                    </div>
                    
                    <button 
                        onClick={handleStartGame}
                        style={{ marginTop: '20px', padding: '10px 20px' }}
                        disabled={GameState.players.length === 0}
                    >
                        Start Game
                    </button>
                </div>
            );
        }
        
        // Game Board Component
        function GameBoard() {
            const [refreshCounter, setRefreshCounter] = React.useState(0);
            
            const handleReset = () => {
                GameState.resetGame();
                setRefreshCounter(prev => prev + 1);
            };
            
            // If game hasn't started, show player setup
            if (!GameState.gameStarted) {
                return (
                    <div>
                        <PlayerSetup onStartGame={() => setRefreshCounter(prev => prev + 1)} />
                        <div className="log-container">
                            <h3>Game Logs</h3>
                            {GameState.logs.map((log, index) => (
                                <div key={index}>{log}</div>
                            ))}
                        </div>
                    </div>
                );
            }
            
            // If game has started, show game board
            return (
                <div>
                    <h2>Game Board (Game In Progress)</h2>
                    <div>
                        <strong>Current Player:</strong> {GameState.players[GameState.currentPlayerIndex]?.name || 'Unknown'}
                    </div>
                    
                    <div className="game-board">
                        {GameState.spaces.slice(0, 12).map(space => (
                            <div key={space.id} className="space">
                                <h3>{space.name}</h3>
                                <div>Type: {space.type}</div>
                            </div>
                        ))}
                    </div>
                    
                    <button 
                        onClick={handleReset}
                        style={{ marginTop: '20px', backgroundColor: '#f44336' }}
                    >
                        Reset Game
                    </button>
                    
                    <div className="log-container">
                        <h3>Game Logs</h3>
                        {GameState.logs.map((log, index) => (
                            <div key={index}>{log}</div>
                        ))}
                    </div>
                </div>
            );
        }
        
        // Main App Component
        function App() {
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            
            React.useEffect(() => {
                async function loadGameData() {
                    try {
                        console.log('Loading game data...');
                        GameState.log('Loading CSV data...');
                        
                        // Load spaces data from CSV
                        const response = await fetch('data/Spaces.csv');
                        const csvText = await response.text();
                        
                        // Parse CSV
                        const spacesData = parseCSV(csvText);
                        GameState.log(`Parsed ${spacesData.length} spaces from CSV`);
                        
                        // Initialize game state with spaces data
                        GameState.initialize(spacesData);
                        
                        setIsLoading(false);
                    } catch (error) {
                        console.error('Error loading game data:', error);
                        GameState.log(`Error loading game data: ${error.message}`);
                        setError(`Failed to load game data: ${error.message}`);
                        setIsLoading(false);
                    }
                }
                
                loadGameData();
            }, []);
            
            if (isLoading) {
                return <div>Loading game data...</div>;
            }
            
            if (error) {
                return (
                    <div style={{ color: 'red', padding: '20px' }}>
                        <h2>Error</h2>
                        <p>{error}</p>
                        <button onClick={() => window.location.reload()}>Reload Page</button>
                    </div>
                );
            }
            
            return <GameBoard />;
        }
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('game-root'));
    </script>
</body>
</html>